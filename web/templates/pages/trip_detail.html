{{template "base" .}}

{{define "content"}}
{{if .Data}}
{{$trip := .Data}}
<div class="trip-detail">
    <div class="trip-header">
        <div class="trip-header-content">
            <div class="trip-breadcrumb">
                <a href="/"><i class="fas fa-home"></i> Home</a>
                <span>/</span>
                <a href="/explore">Explore</a>
                <span>/</span>
                <span>{{$trip.Title}}</span>
            </div>

            <h1>{{$trip.Title}}</h1>

            <div class="trip-header-meta">
                <span class="trip-location">
                    <i class="fas fa-map-marker-alt"></i> {{$trip.Destination}}
                </span>
                <span class="trip-dates">
                    <i class="far fa-calendar"></i>
                    {{$trip.StartDate.Format "Jan 2, 2006"}} - {{$trip.EndDate.Format "Jan 2, 2006"}}
                </span>
                {{if $trip.IsPublic}}
                <span class="badge badge-success">
                    <i class="fas fa-globe"></i> Public
                </span>
                {{end}}
            </div>
        </div>

        {{if .IsAuthenticated}}
        {{if eq $trip.UserID .User.ID}}
        <div class="trip-header-actions">
            <a href="/trips/{{$trip.ID}}/edit" class="btn btn-secondary">
                <i class="fas fa-edit"></i> Edit Trip
            </a>
            <button onclick="deleteTrip('{{$trip.ID}}')" class="btn btn-danger">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
        {{end}}
        {{end}}
    </div>

    <div class="trip-detail-grid">
        <div class="trip-main">
            <!-- Overview Section -->
            <section class="detail-section">
                <h2><i class="fas fa-info-circle"></i> Overview</h2>
                <div class="detail-content">
                    <p>{{if $trip.Description}}{{$trip.Description}}{{else}}No description provided.{{end}}</p>
                </div>
            </section>

            <!-- Budget Section -->
            {{if $trip.Budget}}
            <section class="detail-section">
                <h2><i class="fas fa-euro-sign"></i> Budget</h2>
                <div class="budget-info">
                    <div class="budget-amount">
                        <span class="budget-label">Budget</span>
                        <span class="budget-value">‚Ç¨{{printf "%.2f" $trip.Budget}}</span>
                    </div>
                </div>
            </section>
            {{end}}

            <!-- Activities Section -->
            <section class="detail-section">
                <div class="section-title">
                    <h2><i class="fas fa-hiking"></i> Activities
                        {{if $trip.Activities}}
                        <span class="count-badge">{{len $trip.Activities}}</span>
                        {{end}}
                    </h2>
                </div>

                {{if $trip.Activities}}
                <div class="activity-timeline">
                    {{range $trip.Activities}}
                    <div class="activity-item">
                        <div class="activity-marker">
                            <i class="fas fa-map-pin"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <h3>{{.Name}}</h3>
                                <span class="activity-date">
                                    <i class="far fa-calendar"></i>
                                    {{.Date.Format "Jan 2, 2006"}}
                                </span>
                            </div>
                            {{if .Location}}
                            <p class="activity-location">
                                <i class="fas fa-map-marker-alt"></i> {{.Location}}
                            </p>
                            {{end}}
                            {{if .Description}}
                            <p class="activity-description">{{.Description}}</p>
                            {{end}}
                        </div>
                    </div>
                    {{end}}
                </div>
                {{else}}
                <div class="empty-message">
                    <i class="fas fa-calendar-times"></i>
                    <p>No activities planned yet</p>
                    {{if .IsAuthenticated}}
                    {{if eq $trip.UserID .User.ID}}
                    <p class="empty-hint">Add activities to create your perfect itinerary!</p>
                    {{end}}
                    {{end}}
                </div>
                {{end}}
            </section>

            <!-- Expenses Section -->
            <section class="detail-section">
                <div class="section-title">
                    <h2><i class="fas fa-receipt"></i> Expenses
                        {{if $trip.Expenses}}
                        <span class="count-badge">{{len $trip.Expenses}}</span>
                        {{end}}
                    </h2>
                </div>

                {{if $trip.Expenses}}
                <div class="expense-list">
                    {{range $trip.Expenses}}
                    <div class="expense-item">
                        <div class="expense-icon category-{{.Category}}">
                            <i class="fas fa-{{if eq .Category " food"}}utensils{{else if eq .Category "transport"
                                }}bus{{else if eq .Category "accommodation" }}hotel{{else if eq
                                .Category "entertainment" }}ticket-alt{{else}}shopping-bag{{end}}"></i>
                        </div>
                        <div class="expense-details">
                            <h4 class="expense-category">{{.Category}}</h4>
                            <span class="expense-date">
                                <i class="far fa-calendar"></i>
                                {{.ExpenseDate.Format "Jan 2, 2006"}}
                            </span>
                        </div>
                        <div class="expense-amount">
                            <span class="currency">{{if .Currency}}{{.Currency}}{{else}}EUR{{end}}</span>
                            <span class="amount">{{printf "%.2f" .Amount}}</span>
                        </div>
                    </div>
                    {{end}}
                </div>
                {{else}}
                <div class="empty-message">
                    <i class="fas fa-coins"></i>
                    <p>No expenses recorded yet</p>
                    {{if .IsAuthenticated}}
                    {{if eq $trip.UserID .User.ID}}
                    <p class="empty-hint">Start tracking your expenses to stay within budget!</p>
                    {{end}}
                    {{end}}
                </div>
                {{end}}
            </section>
        </div>

        <div class="trip-sidebar">
            <!-- Trip Info Card -->
            <div class="info-card">
                <h3><i class="fas fa-user"></i> Trip Organizer</h3>
                <div class="organizer-info">
                    <div class="organizer-avatar">
                        {{if $trip.User}}
                        {{substr $trip.User.FirstName 0 1}}{{substr $trip.User.LastName 0 1}}
                        {{end}}
                    </div>
                    <div class="organizer-details">
                        {{if $trip.User}}
                        <p class="organizer-name">{{$trip.User.FirstName}} {{$trip.User.LastName}}</p>
                        <p class="organizer-email">{{$trip.User.Email}}</p>
                        {{end}}
                    </div>
                </div>
            </div>

            <!-- Duration Card -->
            <div class="info-card">
                <h3><i class="fas fa-calendar-alt"></i> Duration</h3>
                <div class="duration-info">
                    <p class="duration-days">
                        {{$days := daysBetween $trip.StartDate $trip.EndDate}}
                        {{$days}} {{if eq $days 1}}day{{else}}days{{end}}
                    </p>
                    <p class="duration-dates">
                        {{$trip.StartDate.Format "Jan 2"}} - {{$trip.EndDate.Format "Jan 2, 2006"}}
                    </p>
                </div>
            </div>

            <!-- Quick Stats Card -->
            <div class="info-card">
                <h3><i class="fas fa-chart-bar"></i> Trip Stats</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <i class="fas fa-hiking"></i>
                        <div>
                            <span class="stat-number">{{if $trip.Activities}}{{len
                                $trip.Activities}}{{else}}0{{end}}</span>
                            <span class="stat-label">Activities</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-receipt"></i>
                        <div>
                            <span class="stat-number">{{if $trip.Expenses}}{{len $trip.Expenses}}{{else}}0{{end}}</span>
                            <span class="stat-label">Expenses</span>
                        </div>
                    </div>
                    {{if $trip.Budget}}
                    <div class="stat-item">
                        <i class="fas fa-euro-sign"></i>
                        <div>
                            <span class="stat-number">‚Ç¨{{printf "%.0f" $trip.Budget}}</span>
                            <span class="stat-label">Budget</span>
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Budget Analysis Card -->
            {{if .IsAuthenticated}}
            {{if eq $trip.UserID .User.ID}}
            {{if $trip.Expenses}}
            <div class="info-card">
                <h3><i class="fas fa-chart-pie"></i> Budget Analysis</h3>
                <button class="btn btn-block btn-primary" onclick="analyzeBudget()">
                    <i class="fas fa-analytics"></i> Analyze Budget
                </button>
                <div id="budgetAnalysis" style="margin-top: 15px;"></div>
            </div>
            {{end}}
            {{end}}
            {{end}}

            <!-- Share Card -->
            {{if $trip.IsPublic}}
            <div class="info-card">
                <h3><i class="fas fa-share-alt"></i> Share This Trip</h3>
                <div class="share-buttons">
                    <button class="share-btn" onclick="shareTrip('facebook')" title="Share on Facebook">
                        <i class="fab fa-facebook"></i>
                    </button>
                    <button class="share-btn" onclick="shareTrip('twitter')" title="Share on Twitter">
                        <i class="fab fa-twitter"></i>
                    </button>
                    <button class="share-btn" onclick="shareTrip('linkedin')" title="Share on LinkedIn">
                        <i class="fab fa-linkedin"></i>
                    </button>
                    <button class="share-btn" onclick="copyLink()" title="Copy Link">
                        <i class="fas fa-link"></i>
                    </button>
                </div>
            </div>
            {{end}}

            <!-- Actions Card -->
            {{if .IsAuthenticated}}
            {{if eq $trip.UserID .User.ID}}
            <div class="info-card">
                <h3><i class="fas fa-tools"></i> Quick Actions</h3>
                <div class="action-buttons">
                    <button class="btn btn-block btn-secondary" onclick="exportTrip()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                    <button class="btn btn-block btn-outline" onclick="printItinerary()">
                        <i class="fas fa-print"></i> Print Itinerary
                    </button>
                </div>
            </div>
            {{end}}
            {{end}}
        </div>
    </div>
</div>

<script>
    async function analyzeBudget() {
        const tripId = '{{$trip.ID}}';

        const budgetDiv = document.getElementById('budgetAnalysis');
        budgetDiv.innerHTML = '<p class="text-muted">Analyzing...</p>';

        try {
            const response = await fetch(`/api/trips/${tripId}/budget/analyze`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`Failed to analyze budget (${response.status})`);
            }

            const data = await response.json();
            displayBudgetAnalysis(data);

        } catch (error) {
            console.error('Budget analysis error:', error);
            budgetDiv.innerHTML = `<p class="text-danger">Analysis failed. Please try again.</p>`;
        }
    }
    function displayBudgetAnalysis(data) {
        const div = document.getElementById('budgetAnalysis');

        let html = `
        <div class="budget-summary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="margin-bottom: 10px; font-size: 1rem;">Budget Summary</h4>
            <p style="margin: 5px 0;"><strong>Total:</strong> ‚Ç¨${data.total_budget.toFixed(2)}</p>
            <p style="margin: 5px 0;"><strong>Spent:</strong> ‚Ç¨${data.total_spent.toFixed(2)}</p>
            <p style="margin: 5px 0;"><strong>Remaining:</strong> ‚Ç¨${data.remaining.toFixed(2)}</p>
        </div>
        
        <h4 style="margin: 15px 0 10px; font-size: 1rem;">Category Breakdown</h4>
        <ul class="category-list" style="list-style: none; padding: 0;">
    `;

        data.category_breakdown.forEach(cat => {
            const icon = cat.status === 'optimal' ? 'üéØ' :
                cat.status === 'warning' ? '‚ö†Ô∏è' : '‚úÖ';
            html += `
            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                ${icon} <strong>${cat.category}:</strong> ‚Ç¨${cat.total_spent.toFixed(2)} 
                <span style="color: #666;">(${cat.percentage.toFixed(1)}%)</span>
            </li>
        `;
        });

        html += '</ul>';

        if (data.warnings && data.warnings.length > 0) {
            html += '<h4 style="margin: 15px 0 10px; font-size: 1rem; color: #dc3545;">‚ö†Ô∏è Warnings</h4><ul style="padding-left: 20px;">';
            data.warnings.forEach(w => html += `<li style="margin: 5px 0;">${w}</li>`);
            html += '</ul>';
        }

        if (data.suggestions && data.suggestions.length > 0) {
            html += '<h4 style="margin: 15px 0 10px; font-size: 1rem; color: #28a745;">üí° Suggestions</h4><ul style="padding-left: 20px;">';
            data.suggestions.forEach(s => html += `<li style="margin: 5px 0;">${s}</li>`);
            html += '</ul>';
        }

        div.innerHTML = html;
    }

    function shareTrip(platform) {
        const url = window.location.href;
        const title = '{{$trip.Title}}';

        let shareUrl;
        switch (platform) {
            case 'facebook':
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
                break;
            case 'twitter':
                shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
                break;
            case 'linkedin':
                shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
                break;
        }

        if (shareUrl) {
            window.open(shareUrl, '_blank', 'width=600,height=400');
        }
    }

    function copyLink() {
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('Link copied to clipboard!');
        });
    }

    function exportTrip() {
        alert('Export functionality coming soon!');
    }

    function printItinerary() {
        window.print();
    }

    function deleteTrip(tripID) {
        if (confirm('Are you sure you want to delete this trip?')) {
            fetch(`/api/trips/${tripID}`, {
                method: 'DELETE',
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Trip deleted successfully!');
                        window.location.href = '/dashboard';
                    } else {
                        alert('Failed to delete trip');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred');
                });
        }
    }
</script>
{{else}}
<div class="error-state">
    <i class="fas fa-exclamation-triangle"></i>
    <h2>Trip Not Found</h2>
    <p>The trip you're looking for doesn't exist or has been removed.</p>
    <a href="/explore" class="btn btn-primary">Browse Other Trips</a>
</div>
{{end}}
{{end}}