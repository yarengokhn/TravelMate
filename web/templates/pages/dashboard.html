{{template "base" .}}

{{define "content"}}
<div class="dashboard">
    <div class="dashboard-header">
        <div>
            <h1>Welcome back, {{.User.FirstName}}!</h1>
            <p>Manage your trips and explore new destinations</p>
        </div>
        <a href="/trips/new" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create New Trip
        </a>
    </div>

    <div class="dashboard-stats">
        <div class="stat-card">
            <i class="fas fa-suitcase"></i>
            <div class="stat-info">
                <h3>{{if .Data}}{{len .Data}}{{else}}0{{end}}</h3>
                <p>Total Trips</p>
            </div>
        </div>

        <div class="stat-card">
            <i class="fas fa-map-marked-alt"></i>
            <div class="stat-info">
                <h3>
                    {{if .Data}}
                    {{$destinations := 0}}
                    {{range .Data}}{{$destinations = add $destinations 1}}{{end}}
                    {{$destinations}}
                    {{else}}0{{end}}
                </h3>
                <p>Destinations</p>
            </div>
        </div>

        <div class="stat-card">
            <i class="fas fa-hiking"></i>
            <div class="stat-info">
                <h3>
                    {{if .Data}}
                    {{$totalActivities := 0}}
                    {{range .Data}}
                    {{if .Activities}}
                    {{$totalActivities = add $totalActivities (len .Activities)}}
                    {{end}}
                    {{end}}
                    {{$totalActivities}}
                    {{else}}0{{end}}
                </h3>
                <p>Activities</p>
            </div>
        </div>

        <div class="stat-card">
            <i class="fas fa-calendar-check"></i>
            <div class="stat-info">
                <h3>
                    {{if .Data}}
                    {{$upcoming := 0}}
                    {{$now := now}}
                    {{range .Data}}
                    {{if .StartDate.After $now}}{{$upcoming = add $upcoming 1}}{{end}}
                    {{end}}
                    {{$upcoming}}
                    {{else}}0{{end}}
                </h3>
                <p>Upcoming</p>
            </div>
        </div>
    </div>

    <div class="dashboard-content">
        <div class="section-header">
            <h2><i class="fas fa-suitcase"></i> My Trips</h2>
            <div class="filter-tabs">
                <button class="tab-btn active" data-filter="all" onclick="filterTrips('all')">All</button>
                <button class="tab-btn" data-filter="upcoming" onclick="filterTrips('upcoming')">Upcoming</button>
                <button class="tab-btn" data-filter="past" onclick="filterTrips('past')">Past</button>
            </div>
        </div>

        {{if .Data}}
        <div class="trip-list">
            {{$now := now}}
            {{range .Data}}
            <div class="trip-item" data-status="{{if .StartDate.After $now}}upcoming{{else}}past{{end}}">
                <div class="trip-item-header">
                    <div>
                        <h3>{{.Title}}</h3>
                        <span class="trip-destination">
                            <i class="fas fa-map-marker-alt"></i> {{.Destination}}
                        </span>
                    </div>
                    <div class="trip-badges">
                        {{if .IsPublic}}
                        <span class="badge badge-success">
                            <i class="fas fa-globe"></i> Public
                        </span>
                        {{else}}
                        <span class="badge badge-secondary">
                            <i class="fas fa-lock"></i> Private
                        </span>
                        {{end}}
                        {{if .StartDate.After $now}}
                        <span class="badge badge-info">
                            <i class="fas fa-clock"></i> Upcoming
                        </span>
                        {{end}}
                    </div>
                </div>

                <div class="trip-item-body">
                    <p>{{if .Description}}{{.Description}}{{else}}No description available.{{end}}</p>
                    <div class="trip-details">
                        <span>
                            <i class="far fa-calendar"></i>
                            {{.StartDate.Format "Jan 2, 2006"}} - {{.EndDate.Format "Jan 2, 2006"}}
                        </span>
                        {{if .Budget}}
                        <span>
                            <i class="fas fa-euro-sign"></i>
                            Budget: â‚¬{{printf "%.2f" .Budget}}
                        </span>
                        {{end}}
                        {{if .Activities}}
                        <span>
                            <i class="fas fa-hiking"></i>
                            {{len .Activities}} {{if eq (len .Activities) 1}}Activity{{else}}Activities{{end}}
                        </span>
                        {{end}}
                        {{if .Expenses}}
                        <span>
                            <i class="fas fa-receipt"></i>
                            {{len .Expenses}} {{if eq (len .Expenses) 1}}Expense{{else}}Expenses{{end}}
                        </span>
                        {{end}}
                    </div>


                </div>

                <div class="trip-item-actions">
                    <a href="/trips/{{.ID}}" class="btn btn-small btn-secondary">
                        <i class="fas fa-eye"></i> View
                    </a>
                    <a href="/trips/{{.ID}}/edit" class="btn btn-small btn-outline">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <button class="btn btn-small btn-danger" onclick="deleteTrip('{{.ID}}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
            {{end}}
        </div>
        {{else}}
        <div class="empty-state">
            <i class="fas fa-suitcase-rolling"></i>
            <h3>No trips yet</h3>
            <p>Start planning your first adventure!</p>
            <a href="/trips/new" class="btn btn-primary">Create Your First Trip</a>
        </div>
        {{end}}
    </div>
</div>

<script>
    function filterTrips(status) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        const trips = document.querySelectorAll('.trip-item');
        trips.forEach(trip => {
            if (status === 'all') {
                trip.style.display = 'block';
            } else {
                trip.style.display = trip.dataset.status === status ? 'block' : 'none';
            }
        });
    }

    function deleteTrip(tripID) {
        if (confirm('Are you sure you want to delete this trip? This action cannot be undone.')) {
            fetch(`/api/trips/${tripID}`, {
                method: 'DELETE',
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Trip deleted successfully!');
                        location.reload();
                    } else {
                        alert('Failed to delete trip');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the trip');
                });
        }
    }
</script>
{{end}}