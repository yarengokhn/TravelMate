{{template "base" .}}

{{define "content"}}
<div class="chat-wrapper">

    <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
            .chat-wrapper {
                min-height: 100vh;
                padding: 20px;
            }

            .chat-container {
                width: 100%;
                max-width: 1200px;
                height: 80vh;
                margin: 0 auto;
                background: white;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                display: flex;
                overflow: hidden;
            }

            /* Sidebar */
            .sidebar {
                width: 300px;
                background: #2c3e50;
                color: white;
                padding: 20px;
                display: flex;
                flex-direction: column;
            }

            .sidebar h2 {
                margin-bottom: 20px;
                font-size: 24px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-size: 14px;
                color: #ecf0f1;
            }

            .form-group input {
                width: 100%;
                padding: 10px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
            }

            .btn {
                width: 100%;
                padding: 12px;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .btn-primary {
                background: #3498db;
                color: white;
            }

            .btn-primary:hover {
                background: #2980b9;
            }

            .btn-danger {
                background: #e74c3c;
                color: white;
                margin-top: 10px;
            }

            .status {
                margin-top: 15px;
                padding: 10px;
                border-radius: 8px;
                font-size: 14px;
                display: none;
            }

            .status.success {
                background: #27ae60;
                color: white;
            }

            .status.error {
                background: #e74c3c;
                color: white;
            }

            /* Chat Area */
            .chat-main {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .chat-header {
                background: #34495e;
                color: white;
                padding: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .chat-header h1 {
                font-size: 20px;
            }

            .online-count {
                background: #27ae60;
                padding: 5px 10px;
                border-radius: 12px;
                font-size: 14px;
            }

            .messages {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                background: #ecf0f1;
            }

            .message {
                margin-bottom: 15px;
                animation: slideIn 0.3s ease;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .message.system {
                text-align: center;
                color: #7f8c8d;
                font-style: italic;
                font-size: 14px;
            }

            .message.user {
                background: white;
                padding: 12px 15px;
                border-radius: 12px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }

            .message-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
            }

            .sender {
                font-weight: bold;
                color: #3498db;
            }

            .time {
                font-size: 12px;
                color: #95a5a6;
            }

            .message-text {
                color: #2c3e50;
            }

            .input-area {
                padding: 20px;
                background: white;
                border-top: 1px solid #ecf0f1;
                display: flex;
                gap: 10px;
            }

            .input-area input {
                flex: 1;
                padding: 12px;
                border: 1px solid #bdc3c7;
                border-radius: 25px;
                font-size: 14px;
            }

            .input-area button {
                padding: 12px 24px;
                background: #3498db;
                color: white;
                border: none;
                border-radius: 25px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .input-area button:hover {
                background: #2980b9;
            }

            .input-area button:disabled {
                background: #95a5a6;
                cursor: not-allowed;
            }

            .waiting-screen {
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                color: #7f8c8d;
            }

            .waiting-screen i {
                font-size: 64px;
                margin-bottom: 20px;
                color: #3498db;
            }

            /* Scrollbar */
            .messages::-webkit-scrollbar {
                width: 8px;
            }

            .messages::-webkit-scrollbar-track {
                background: #ecf0f1;
            }

            .messages::-webkit-scrollbar-thumb {
                background: #95a5a6;
                border-radius: 4px;
            }
        </style>
        <div class="chat-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <h2><i class="fas fa-comments"></i> TravelMate Chat</h2>

                <div class="form-group">
                    <label>Kullanıcı Adı</label>
                    <input type="text" id="username" value="{{if .User}}{{.User.FirstName}} {{.User.LastName}}{{end}}"
                        readonly style="background: #34495e;">
                </div>

                <input type="hidden" id="userId" value="{{if .User}}{{.User.ID}}{{end}}">

                <div class="form-group">
                    <label>Oda Adı</label>
                    <input type="text" id="roomName" placeholder="Örn: Paris 2026">
                </div>

                <button class="btn btn-primary" id="connectBtn">
                    <i class="fas fa-plug"></i> Bağlan
                </button>

                <button class="btn btn-danger" id="disconnectBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Ayrıl
                </button>

                <div class="status" id="status"></div>
            </div>

            <!-- Chat Area -->
            <div class="chat-main">
                <div id="waitingScreen" class="waiting-screen">
                    <i class="fas fa-comments"></i>
                    <h2>Sohbete Katıl</h2>
                    <p>Bilgilerinizi girin ve bağlan!</p>
                </div>

                <div id="chatArea" style="display: none; flex: 1; display: flex; flex-direction: column;">
                    <div class="chat-header">
                        <h1 id="roomTitle">Chat Odası</h1>
                        <span class="online-count">
                            <i class="fas fa-circle"></i> Çevrimiçi
                        </span>
                    </div>

                    <div class="messages" id="messages"></div>

                    <div class="input-area">
                        <input type="text" id="messageInput" placeholder="Mesajınızı yazın..." disabled>
                        <button id="sendBtn" disabled>
                            <i class="fas fa-paper-plane"></i> Gönder
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let ws = null;
            let connected = false;

            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');
            const messagesDiv = document.getElementById('messages');
            const statusDiv = document.getElementById('status');
            const waitingScreen = document.getElementById('waitingScreen');
            const chatArea = document.getElementById('chatArea');

            connectBtn.addEventListener('click', connect);
            disconnectBtn.addEventListener('click', disconnect);
            sendBtn.addEventListener('click', sendMessage);

            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            function connect() {
                const username = document.getElementById('username').value.trim();
                const userId = document.getElementById('userId').value.trim();
                const roomName = document.getElementById('roomName').value.trim();

                if (!roomName) {
                    showStatus('Lütfen oda adı girin!', 'error');
                    return;
                }

                showStatus('Bağlanıyor...', 'success');
                connectBtn.disabled = true;

                ws = new WebSocket('ws://localhost:8080/ws/chat');

                ws.onopen = () => {
                    setTimeout(() => ws.send(username), 100);
                    setTimeout(() => ws.send(userId), 200);
                    setTimeout(() => ws.send(roomName), 300);

                    connected = true;
                    showStatus('Bağlandı!', 'success');
                    showChatArea(roomName);
                };

                ws.onmessage = (event) => {
                    displayMessage(event.data);
                };

                ws.onerror = () => {
                    showStatus('Bağlantı hatası!', 'error');
                    connectBtn.disabled = false;
                };

                ws.onclose = () => {
                    connected = false;
                    showStatus('Bağlantı kesildi', 'error');
                    hideChatArea();
                };
            }

            function disconnect() {
                if (ws && connected) {
                    ws.send('STOP');
                    ws.close();
                }
            }

            function sendMessage() {
                const message = messageInput.value.trim();
                if (!message || !connected) return;

                ws.send(message);
                messageInput.value = '';
            }

            function displayMessage(text) {
                const div = document.createElement('div');

                if (text.includes('***') || text.includes('Welcome') || text.includes('joined') || text.includes('left')) {
                    div.className = 'message system';
                    div.textContent = text;
                } else {
                    const match = text.match(/\[(\d{2}:\d{2}:\d{2})\]\s*([^:]+):\s*(.+)/);
                    if (match) {
                        const [, time, sender, message] = match;
                        div.className = 'message user';
                        div.innerHTML = `
                        <div class="message-header">
                            <span class="sender">${sender}</span>
                            <span class="time">${time}</span>
                        </div>
                        <div class="message-text">${message}</div>
                    `;
                    } else {
                        div.className = 'message system';
                        div.textContent = text;
                    }
                }

                messagesDiv.appendChild(div);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            function showStatus(message, type) {
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
                statusDiv.style.display = 'block';
            }

            function showChatArea(roomName) {
                waitingScreen.style.display = 'none';
                chatArea.style.display = 'flex';
                document.getElementById('roomTitle').textContent = roomName;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
            }

            function hideChatArea() {
                chatArea.style.display = 'none';
                waitingScreen.style.display = 'flex';
                messageInput.disabled = true;
                sendBtn.disabled = true;
                messagesDiv.innerHTML = '';
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
                connectBtn.disabled = false;
            }
        </script>
</div>
{{end}}