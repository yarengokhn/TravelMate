{{template "base" .}}

{{define "content"}}
<div class="chat-container">
    <div class="chat-header">
        <h1><i class="fas fa-comments"></i> TravelMate Chat</h1>
        <p>Connect with travelers in real-time</p>
    </div>

    <div class="chat-layout">
        <!-- Sol Panel - Bağlantı Formu -->
        <div class="chat-sidebar" id="connectionPanel">
            <div class="connection-form">
                <h3><i class="fas fa-sign-in-alt"></i> Join Chat</h3>

                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter your name"
                        value="{{if .User}}{{.User.FirstName}}{{end}}" required>
                </div>

                <div class="form-group">
                    <label for="userId">User ID</label>
                    <input type="number" id="userId" placeholder="Your user ID" value="{{if .User}}{{.User.ID}}{{end}}"
                        required>
                </div>

                <div class="form-group">
                    <label for="roomName">Room Name</label>
                    <input type="text" id="roomName" placeholder="e.g., Paris 2026" required>
                    <small class="form-hint">Enter existing room or create new one</small>
                </div>

                <button id="connectBtn" class="btn btn-primary btn-block">
                    <i class="fas fa-plug"></i> Connect to Chat
                </button>

                <div id="connectionStatus" class="connection-status"></div>
            </div>

            <div class="info-card">
                <i class="fas fa-info-circle"></i>
                <h4>Chat Tips</h4>
                <ul>
                    <li>Choose a unique username</li>
                    <li>Join existing rooms or create new ones</li>
                    <li>Type "STOP" to disconnect</li>
                    <li>Be respectful to other travelers</li>
                </ul>
            </div>
        </div>

        <!-- Sağ Panel - Chat Alanı -->
        <div class="chat-main">
            <div id="chatArea" class="chat-area" style="display: none;">
                <div class="chat-room-info">
                    <h3 id="currentRoom"></h3>
                    <button id="disconnectBtn" class="btn btn-small btn-danger">
                        <i class="fas fa-sign-out-alt"></i> Disconnect
                    </button>
                </div>

                <div id="messageContainer" class="message-container"></div>

                <div class="message-input-container">
                    <input type="text" id="messageInput" placeholder="Type your message..." disabled>
                    <button id="sendBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>

            <div id="waitingArea" class="waiting-area">
                <i class="fas fa-comments"></i>
                <h3>Ready to Chat?</h3>
                <p>Enter your details and connect to start chatting with travelers</p>
            </div>
        </div>
    </div>
</div>

<style>
    .chat-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .chat-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .chat-header h1 {
        color: #2c3e50;
        margin-bottom: 10px;
    }

    .chat-layout {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 20px;
        min-height: 600px;
    }

    .chat-sidebar {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .connection-form h3 {
        margin-bottom: 20px;
        color: #2c3e50;
    }

    .connection-status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        font-size: 14px;
        display: none;
    }

    .connection-status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        display: block;
    }

    .connection-status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        display: block;
    }

    .chat-main {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
    }

    .chat-area {
        display: flex;
        flex-direction: column;
        height: 600px;
    }

    .chat-room-info {
        padding: 15px 20px;
        border-bottom: 2px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8f9fa;
        border-radius: 10px 10px 0 0;
    }

    .chat-room-info h3 {
        margin: 0;
        color: #2c3e50;
    }

    .message-container {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
    }

    .message {
        margin-bottom: 15px;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.system {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        font-size: 14px;
    }

    .message.user {
        background: white;
        padding: 12px 15px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .message-sender {
        font-weight: 600;
        color: #007bff;
    }

    .message-time {
        font-size: 12px;
        color: #6c757d;
    }

    .message-text {
        color: #2c3e50;
        line-height: 1.5;
    }

    .message-input-container {
        display: flex;
        gap: 10px;
        padding: 15px 20px;
        border-top: 2px solid #e9ecef;
        background: white;
        border-radius: 0 0 10px 10px;
    }

    #messageInput {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        font-size: 14px;
    }

    #messageInput:focus {
        outline: none;
        border-color: #007bff;
    }

    .waiting-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 600px;
        color: #6c757d;
    }

    .waiting-area i {
        font-size: 64px;
        margin-bottom: 20px;
        color: #007bff;
    }

    .info-card {
        margin-top: 20px;
        padding: 15px;
        background: #e7f3ff;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }

    .info-card h4 {
        margin-bottom: 10px;
        color: #2c3e50;
    }

    .info-card ul {
        margin: 0;
        padding-left: 20px;
        color: #495057;
    }

    .info-card ul li {
        margin-bottom: 5px;
        font-size: 14px;
    }

    @media (max-width: 768px) {
        .chat-layout {
            grid-template-columns: 1fr;
        }

        .chat-sidebar {
            order: 2;
        }
    }
</style>

<script>
    let ws = null;
    let connected = false;
    let currentUsername = '';
    let currentRoom = '';

    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');
    const messageContainer = document.getElementById('messageContainer');
    const connectionStatus = document.getElementById('connectionStatus');
    const chatArea = document.getElementById('chatArea');
    const waitingArea = document.getElementById('waitingArea');

    // Connect butonuna tıklama
    connectBtn.addEventListener('click', connectToChat);

    // Disconnect butonuna tıklama
    disconnectBtn.addEventListener('click', disconnect);

    // Send butonuna tıklama
    sendBtn.addEventListener('click', sendMessage);

    // Enter tuşu ile mesaj gönder
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function connectToChat() {
        const username = document.getElementById('username').value.trim();
        const userId = document.getElementById('userId').value.trim();
        const roomName = document.getElementById('roomName').value.trim();

        if (!username || !userId || !roomName) {
            showStatus('Please fill all fields', 'error');
            return;
        }

        showStatus('Connecting...', 'success');
        connectBtn.disabled = true;

        // WebSocket bağlantısı
        ws = new WebSocket('ws://localhost:8080/ws/chat');

        ws.onopen = () => {
            console.log('WebSocket connected');

            // Kullanıcı bilgilerini gönder
            setTimeout(() => ws.send(username), 100);
            setTimeout(() => ws.send(userId), 200);
            setTimeout(() => ws.send(roomName), 300);

            currentUsername = username;
            currentRoom = roomName;
            connected = true;

            showStatus('Connected!', 'success');
            showChatArea();
        };

        ws.onmessage = (event) => {
            displayMessage(event.data);
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            showStatus('Connection error!', 'error');
            connectBtn.disabled = false;
        };

        ws.onclose = () => {
            console.log('WebSocket disconnected');
            connected = false;
            showStatus('Disconnected', 'error');
            connectBtn.disabled = false;
            hideChatArea();
        };
    }

    function disconnect() {
        if (ws && connected) {
            ws.send('STOP');
            ws.close();
        }
    }

    function sendMessage() {
        const message = messageInput.value.trim();

        if (!message || !connected) {
            return;
        }

        ws.send(message);
        messageInput.value = '';
        messageInput.focus();
    }

    function displayMessage(text) {
        const messageDiv = document.createElement('div');

        // Sistem mesajı kontrolü
        if (text.includes('***') || text.includes('Welcome to') || text.includes('joined') || text.includes('left')) {
            messageDiv.className = 'message system';
            messageDiv.textContent = text;
        } else {
            // Normal mesaj formatı: [15:04:05] Username: Message
            const match = text.match(/\[(\d{2}:\d{2}:\d{2})\]\s*([^:]+):\s*(.+)/);

            if (match) {
                const [, time, sender, message] = match;
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${sender}</span>
                    <span class="message-time">${time}</span>
                </div>
                <div class="message-text">${message}</div>
            `;
            } else {
                // Format eşleşmezse düz metin olarak göster
                messageDiv.className = 'message system';
                messageDiv.textContent = text;
            }
        }

        messageContainer.appendChild(messageDiv);
        messageContainer.scrollTop = messageContainer.scrollHeight;
    }

    function showStatus(message, type) {
        connectionStatus.textContent = message;
        connectionStatus.className = `connection-status ${type}`;
    }

    function showChatArea() {
        waitingArea.style.display = 'none';
        chatArea.style.display = 'flex';
        document.getElementById('currentRoom').textContent = `Room: ${currentRoom}`;
        messageInput.disabled = false;
        sendBtn.disabled = false;
        messageInput.focus();
    }

    function hideChatArea() {
        chatArea.style.display = 'none';
        waitingArea.style.display = 'flex';
        messageInput.disabled = true;
        sendBtn.disabled = true;
        messageContainer.innerHTML = '';
    }
</script>
{{end}}